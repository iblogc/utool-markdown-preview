<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Markdown 预览</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html,
      body {
        width: 100%;
        min-height: 100%;
        overflow: auto;
      }
      .toolbar {
        position: fixed;
        top: 16px;
        right: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 1000;
      }
      .toolbar.dark,
      .toolbar.light {
        background-color: transparent;
        border: none;
      }
      .btn {
        padding: 6px 16px;
        border: 1px solid transparent;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .btn-primary {
        background-color: #238636;
        color: white;
      }
      .btn-primary:hover {
        background-color: #2ea043;
        box-shadow: 0 4px 12px rgba(35, 134, 54, 0.3);
        transform: translateY(-1px);
      }
      .btn-secondary {
        background-color: #21262d;
        border-color: #30363d;
        color: #c9d1d9;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }
      .toolbar.light .btn-secondary {
        background-color: #ffffff;
        border-color: #d0d7de;
        color: #24292f;
      }
      .btn-secondary:hover {
        background-color: #30363d;
        border-color: #8b949e;
      }
      .toolbar.light .btn-secondary:hover {
        background-color: #f6f8fa;
      }
      .toolbar-actions {
        display: flex;
        gap: 8px;
      }
      .container {
        padding: 20px;
        min-height: 100%;
      }
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 200px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div id="toolbar" class="toolbar dark"></div>
    <div id="app" class="container">
      <div class="loading">等待渲染内容...</div>
    </div>
    <script>
      var currentMdText = '';
      var currentHtml = '';
      var currentIsDark = true;

      var getStyles = function (isDark) {
        return (
          'body{background-color:' +
          (isDark ? '#0d1117' : '#ffffff') +
          ';color:' +
          (isDark ? '#c9d1d9' : '#24292f') +
          ';font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;font-size:16px;line-height:1.6;margin:0;padding:20px}.markdown-body{max-width:900px;margin:0 auto}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em;border-bottom:1px solid ' +
          (isDark ? '#30363d' : '#d0d7de') +
          ';padding-bottom:.3em}.markdown-body h2{font-size:1.5em;border-bottom:1px solid ' +
          (isDark ? '#30363d' : '#d0d7de') +
          ';padding-bottom:.3em}.markdown-body h3{font-size:1.25em}.markdown-body p{margin-top:0;margin-bottom:16px}.markdown-body a{color:' +
          (isDark ? '#58a6ff' : '#0969da') +
          ';text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body code{font-family:"SFMono-Regular",Consolas,monospace;font-size:85%;padding:.2em .4em;background-color:' +
          (isDark ? 'rgba(110,118,129,0.4)' : 'rgba(175,184,193,0.2)') +
          ';border-radius:4px}.markdown-body pre{margin-top:0;margin-bottom:16px;font-size:85%;padding:16px;overflow:auto;background-color:' +
          (isDark ? '#161b22' : '#f6f8fa') +
          ';border-radius:6px}.markdown-body pre code{padding:0;background-color:transparent;font-size:100%}.markdown-body blockquote{margin:0;padding:0 1em;color:' +
          (isDark ? '#8b949e' : '#57606a') +
          ';border-left:.25em solid ' +
          (isDark ? '#30363d' : '#d0d7de') +
          '}.markdown-body ul,.markdown-body ol{padding-left:2em;margin-top:0;margin-bottom:16px}.markdown-body li{margin-top:.25em}.markdown-body img{max-width:100%}.markdown-body table{display:block;width:100%;overflow:auto;border-spacing:0;border-collapse:collapse;margin-bottom:16px}.markdown-body table th,.markdown-body table td{padding:6px 13px;border:1px solid ' +
          (isDark ? '#30363d' : '#d0d7de') +
          '}.markdown-body table tr{background-color:' +
          (isDark ? '#161b22' : '#ffffff') +
          ';border-top:1px solid ' +
          (isDark ? '#30363d' : '#d0d7de') +
          '}.markdown-body table tr:nth-child(2n){background-color:' +
          (isDark ? '#0d1117' : '#f6f8fa') +
          '}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:' +
          (isDark ? '#30363d' : '#d0d7de') +
          ';border:0}.mermaid{display:flex;justify-content:center;margin:20px 0}'
        );
      };

      var downloadMd = function () {
        if (!currentMdText || typeof window.saveFile !== 'function') return;
        var fileName = 'markdown_' + Date.now() + '.md';
        window.saveFile(fileName, currentMdText);
      };

      var generateFullHtml = function (html, isDark) {
        return (
          '<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><title>Markdown 预览</title><style>' +
          getStyles(isDark) +
          '</style></head><body><div class="markdown-body">' +
          html +
          '</div></body></html>'
        );
      };

      var downloadHtml = async function () {
        if (!currentHtml || typeof window.saveFile !== 'function') return;
        var processedHtml = await renderMermaidForDownload(currentHtml);
        var fullHtml = generateFullHtml(processedHtml, currentIsDark);
        var fileName = 'markdown_' + Date.now() + '.html';
        window.saveFile(fileName, fullHtml);
      };

      var renderMermaidForDownload = async function (html) {
        var parser = new DOMParser();
        var doc = parser.parseFromString(html, 'text/html');
        var mermaidBlocks = [];
        var pres = doc.querySelectorAll('pre');
        for (var i = 0; i < pres.length; i++) {
          var pre = pres[i];
          var code = pre.querySelector('code');
          if (code) {
            var text = (code.textContent || '').trim();
            if (isMermaidCode(text)) {
              mermaidBlocks.push({ element: pre, text: text });
            }
          }
        }
        if (
          mermaidBlocks.length > 0 &&
          typeof mermaid !== 'undefined' &&
          mermaid.render
        ) {
          for (var j = 0; j < mermaidBlocks.length; j++) {
            var block = mermaidBlocks[j];
            var id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
            try {
              var result = await mermaid.render(id, block.text);
              var div = doc.createElement('div');
              div.className = 'mermaid';
              div.innerHTML = result.svg;
              block.element.parentNode.replaceChild(div, block.element);
            } catch (e) {
              console.error('mermaid render error:', e);
            }
          }
        }
        return doc.body.innerHTML;
      };

      var isMermaidCode = function (text) {
        var t = (text || '').trim();
        if (!t) return false;
        var keywords = [
          'graph',
          'flowchart',
          'sequenceDiagram',
          'classDiagram',
          'stateDiagram',
          'gantt',
          'pie',
          'erDiagram',
          'journey',
          'mindmap',
          'timeline',
          'xychart',
        ];
        for (var i = 0; i < keywords.length; i++) {
          if (t.indexOf(keywords[i]) === 0) return true;
        }
        return false;
      };

      var renderMermaid = function () {
        var pres = document.querySelectorAll('pre');
        for (var i = 0; i < pres.length; i++) {
          var pre = pres[i];
          var code = pre.querySelector('code');
          if (code) {
            var text = (code.textContent || '').trim();
            if (isMermaidCode(text)) {
              var d = document.createElement('div');
              d.className = 'mermaid';
              d.textContent = text;
              pre.parentNode.replaceChild(d, pre);
            }
          }
        }

        var codes = document.querySelectorAll(
          'code[class*="language-mermaid"], code[class*="mermaid"]',
        );
        for (var j = 0; j < codes.length; j++) {
          var c = codes[j];
          var ct = (c.textContent || '').trim();
          if (isMermaidCode(ct)) {
            var dm = document.createElement('div');
            dm.className = 'mermaid';
            dm.textContent = ct;
            c.parentNode.replaceChild(dm, c);
          }
        }

        var mermaids = document.querySelectorAll('.mermaid');
        if (mermaids.length > 0) {
          var s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js';
          s.onload = function () {
            try {
              mermaid.initialize({ theme: currentIsDark ? 'dark' : 'default' });
              mermaid.run();
            } catch (e) {
              console.error('mermaid error:', e);
            }
          };
          s.onerror = function (e) {
            console.error('mermaid script load error:', e);
          };
          document.body.appendChild(s);
        }
      };

      window.renderContent = function (data) {
        try {
          currentHtml = data.html || '';
          currentIsDark = data.isDark !== false;
          if (data.mdText) currentMdText = data.mdText;

          var toolbar = document.getElementById('toolbar');
          toolbar.className = 'toolbar ' + (currentIsDark ? 'dark' : 'light');
          toolbar.innerHTML =
            '<div class="toolbar-actions">' +
            '<button class="btn btn-secondary" title="下载 Markdown" onclick="downloadMd()">' +
            '<span>下载 MD</span>' +
            '</button>' +
            '<button class="btn btn-primary" title="下载 HTML" onclick="downloadHtml()">' +
            '<span>下载 HTML</span>' +
            '</button>' +
            '</div>';

          var app = document.getElementById('app');
          app.innerHTML =
            '<style>' +
            getStyles(currentIsDark) +
            '</style><div class="markdown-body">' +
            currentHtml +
            '</div>';

          setTimeout(renderMermaid, 200);
        } catch (e) {
          console.error('renderContent error:', e);
        }
      };
    </script>
  </body>
</html>
